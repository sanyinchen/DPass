import java.lang.reflect.Field

afterEvaluate {
    project.rootProject.allprojects {
        def itProject = it
        itProject.configurations.all {
            def itConfig = it
            itConfig.resolutionStrategy {

                dependencySubstitution {
                    final Map<String, ComponentSelector> selectorMap = new HashMap<>();
                    for (Action<? super DependencySubstitution> item : substitutionRules) {
                        String className = item.getClass().getName();
                        Class refectClass = item.getClass()
                        if (className.contains("ModuleMatchDependencySubstitutionAction")) {
                            Field substituteField = refectClass.getDeclaredField("substitute")
                            substituteField.setAccessible(true);
                            ComponentSelector substitute = substituteField.get(item)

                            Field moduleIdField = refectClass.getDeclaredField("moduleId")
                            moduleIdField.setAccessible(true);
                            ModuleIdentifier moduleId = moduleIdField.get(item)

                            selectorMap.put(moduleId.toString(), substitute);
                            continue
                        }
                        if (className.contains("ExactMatchDependencySubstitutionAction")) {
                            Field substituteField = refectClass.getDeclaredField("substitute")
                            substituteField.setAccessible(true);
                            ComponentSelector substitute = substituteField.get(item)

                            Field substitutedField = refectClass.getDeclaredField("substituted")
                            substitutedField.setAccessible(true);
                            ComponentSelector substituted = substitutedField.get(item)

                            selectorMap.put(substituted.getDisplayName(), substitute);

                            continue
                        }
                    }

                    it.all { dependencySubstitution ->
                        ComponentSelector request = dependencySubstitution.getRequested();
                        ComponentSelector target = dependencySubstitution.getTarget();
                        String requestDisplayName = request.getDisplayName();
                        String targetDisplayName = target.getDisplayName();
                        if (requestDisplayName == null || requestDisplayName.equals(targetDisplayName)) {
                            return
                        }

                        for (String item : selectorMap.keySet()) {
                            if (targetDisplayName.equals(item)) {
                                println("old substitute : " + request + " => " + target);
                                println("new substitute" + request + " => " + selectorMap.get(item)+"\n");
                                dependencySubstitution.useTarget(selectorMap.get(item))
                                break;
                            }
                        }

                    }

                }
            }
        }
    }
}